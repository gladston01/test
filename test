import groovy.json.JsonSlurper
import java.nio.file.Files
import java.nio.file.Paths
import java.nio.file.StandardOpenOption

// Define the CSV file path
def csvFilePath = '/path/to/your/output.csv'

// Read the response from the previous sampler
def response = prev.getResponseDataAsString()

// Parse the JSON response
def jsonSlurper = new JsonSlurper()
def jsonResponse = jsonSlurper.parseText(response)

// Extract the "data" array (assuming it is an array of objects)
def jsonResponse1 = jsonResponse.data

// Check if "data" is null or empty to control the loop
if (jsonResponse1 == null || jsonResponse1.isEmpty()) {
    vars.put("continueLoop", "false")  // Stop the loop
    log.info("No more data. Setting continueLoop to false.")
} else {
    vars.put("continueLoop", "true")   // Continue the loop
    log.info("Data found. Setting continueLoop to true.")

    // Create the CSV file if it doesn't exist
    if (!Files.exists(Paths.get(csvFilePath))) {
        Files.createFile(Paths.get(csvFilePath))
        
        // Write the header row to the CSV (use keys from the first row of data)
        def header = jsonResponse1[0].keySet().join(",") + "\n"
        Files.write(Paths.get(csvFilePath), header.getBytes(), StandardOpenOption.APPEND)
    }

    // Iterate over each row of data and write it to the CSV
    jsonResponse1.each { row ->
        if (row instanceof Map) {  // Ensure the row is a Map object
            // Convert the row map values to a comma-separated string
            def csvRow = row.values().join(",") + "\n"
            
            // Append the row to the CSV file
            Files.write(Paths.get(csvFilePath), csvRow.getBytes(), StandardOpenOption.APPEND)
        } else {
            log.warn("Row is not a Map: ${row}")
        }
    }
}
